#!/bin/bash
# =============================================================================
# –°–ö–†–ò–ü–¢ –û–ë–ù–û–í–õ–ï–ù–ò–Ø ANTI-SPAM BOT
# =============================================================================

# –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ —Å–∫—Ä–∏–ø—Ç–∞
SCRIPT_NAME="AntiSpam Bot Updater"
SCRIPT_VERSION="2.0.0"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_DIR="$(dirname "$SCRIPT_DIR")"

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m'

# –§—É–Ω–∫—Ü–∏–∏ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è
log() { echo -e "${BLUE}[$(date '+%Y-%m-%d %H:%M:%S')]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }
info() { echo -e "${CYAN}[INFO]${NC} $1"; }

# –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
BOT_DIR=""
BACKUP_DIR=""
SERVICE_NAME="antispam-bot"
INSTALLATION_TYPE=""

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∑–∞–≥–æ–ª–æ–≤–∫–∞
show_header() {
    echo -e "${GREEN}"
    echo "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó"
    echo "‚ïë                    ANTI-SPAM BOT UPDATER                     ‚ïë"
    echo "‚ïë                                                              ‚ïë"
    echo "‚ïë  üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –±–æ—Ç–∞                          ‚ïë"
    echo "‚ïë  üõ°Ô∏è –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π                                ‚ïë"
    echo "‚ïë  üîß –ü–æ–¥–¥–µ—Ä–∂–∫–∞ Docker –∏ systemd                              ‚ïë"
    echo "‚ïë  üì¶ –ú–æ–¥—É–ª—å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ (v$SCRIPT_VERSION)                ‚ïë"
    echo "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù"
    echo -e "${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∞–≤ root
check_root() {
    if [ "$EUID" -ne 0 ]; then
        error "–≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
detect_bot_directory() {
    info "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞..."
    
    # –í–æ–∑–º–æ–∂–Ω—ã–µ –ø—É—Ç–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    local possible_paths=(
        "/opt/antispam-bot"
        "/opt/Flame_Of_Styx_bot"
        "$HOME/bots/Flame_Of_Styx_bot"
        "$HOME/bots/antispam-bot"
        "/home/$(whoami)/bots/Flame_Of_Styx_bot"
        "/home/$(whoami)/bots/antispam-bot"
    )
    
    # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –µ—Å–ª–∏ –º—ã –≤ –Ω–µ–π
    if [ -f "bot.py" ] && [ -f "requirements.txt" ]; then
        possible_paths=("$(pwd)" "${possible_paths[@]}")
    fi
    
    for path in "${possible_paths[@]}"; do
        if [ -d "$path" ] && [ -f "$path/bot.py" ] && [ -f "$path/requirements.txt" ]; then
            BOT_DIR="$path"
            BACKUP_DIR="$(dirname "$path")/antispam-bot-backups"
            success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞: $BOT_DIR"
            return 0
        fi
    done
    
    error "–ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞"
    error "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ —Ñ–∞–π–ª—ã bot.py –∏ requirements.txt —Å—É—â–µ—Å—Ç–≤—É—é—Ç"
    exit 1
}

# –§—É–Ω–∫—Ü–∏—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è —Ç–∏–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏
detect_installation_type() {
    info "–û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —Ç–∏–ø–∞ —É—Å—Ç–∞–Ω–æ–≤–∫–∏..."
    
    if systemctl is-active --quiet "${SERVICE_NAME}-docker" 2>/dev/null; then
        INSTALLATION_TYPE="docker"
        success "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ Docker —É—Å—Ç–∞–Ω–æ–≤–∫–∞"
    elif systemctl is-active --quiet "$SERVICE_NAME" 2>/dev/null; then
        INSTALLATION_TYPE="systemd"
        success "–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ systemd —É—Å—Ç–∞–Ω–æ–≤–∫–∞"
    else
        error "–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏"
        error "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –∑–∞–ø—É—â–µ–Ω"
        exit 1
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –±–æ—Ç–∞
check_bot_directory() {
    if [ ! -d "$BOT_DIR" ]; then
        error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $BOT_DIR"
        error "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –±–æ—Ç –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
        exit 1
    fi
    
    if [ ! -f "$BOT_DIR/bot.py" ]; then
        error "–§–∞–π–ª bot.py –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $BOT_DIR"
        error "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —ç—Ç–æ –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–æ—Ç–∞"
        exit 1
    fi
    
    success "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–æ—Ç–∞ –Ω–∞–π–¥–µ–Ω–∞: $BOT_DIR"
}

# –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
create_backup() {
    info "–°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏..."
    
    local timestamp=$(date +%Y%m%d-%H%M%S)
    local backup_path="$BACKUP_DIR/backup-$timestamp"
    
    # –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –±—ç–∫–∞–ø–æ–≤
    mkdir -p "$BACKUP_DIR"
    
    # –°–æ–∑–¥–∞–µ–º –±—ç–∫–∞–ø
    cp -r "$BOT_DIR" "$backup_path"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    if [ "$INSTALLATION_TYPE" = "systemd" ]; then
        cp "/etc/systemd/system/$SERVICE_NAME.service" "$backup_path/" 2>/dev/null || true
        cp "/etc/$SERVICE_NAME/.env" "$backup_path/" 2>/dev/null || true
    fi
    
    success "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è —Å–æ–∑–¥–∞–Ω–∞: $backup_path"
    echo "$backup_path"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
check_updates() {
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π..."
    
    cd "$BOT_DIR"
    
    # –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º –∫–æ–º–º–∏—Ç–µ
    if ! git fetch origin 2>/dev/null; then
        error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ git"
        warning "–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å git safe.directory:"
        warning "git config --global --add safe.directory $BOT_DIR"
        return 1
    fi
    
    local local_commit=$(git rev-parse HEAD)
    local remote_commit=$(git rev-parse origin/master)
    
    if [ "$local_commit" = "$remote_commit" ]; then
        success "–£ –≤–∞—Å —É–∂–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –≤–µ—Ä—Å–∏—è"
        return 1
    else
        warning "–î–æ—Å—Ç—É–ø–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ"
        info "–õ–æ–∫–∞–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è: $local_commit"
        info "–£–¥–∞–ª–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è: $remote_commit"
        return 0
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–µ—Ä–≤–∏—Å–∞
stop_service() {
    info "–û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–µ—Ä–≤–∏—Å–∞..."
    
    if [ "$INSTALLATION_TYPE" = "docker" ]; then
        systemctl stop "${SERVICE_NAME}-docker" || true
    else
        systemctl stop "$SERVICE_NAME" || true
    fi
    
    # –ñ–¥–µ–º –æ—Å—Ç–∞–Ω–æ–≤–∫–∏
    sleep 3
    
    success "–°–µ—Ä–≤–∏—Å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞
fix_permissions() {
    info "–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
    
    if [ ! -d "$BOT_DIR" ]; then
        error "–î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –±–æ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞: $BOT_DIR"
        return 1
    fi
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    local bot_user=$(stat -c '%U' "$BOT_DIR" 2>/dev/null)
    local bot_group=$(stat -c '%G' "$BOT_DIR" 2>/dev/null)
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ systemd —Å–µ—Ä–≤–∏—Å—É
    if [ -z "$bot_user" ] || [ -z "$bot_group" ]; then
        if systemctl is-active --quiet antispam-bot.service 2>/dev/null; then
            bot_user=$(systemctl show -p User --value antispam-bot.service 2>/dev/null || echo "")
            bot_group=$(systemctl show -p Group --value antispam-bot.service 2>/dev/null || echo "")
        fi
    fi
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if [ -z "$bot_user" ] || [ -z "$bot_group" ]; then
        bot_user=$(whoami)
        bot_group=$(id -gn)
    fi
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    chown -R "$bot_user:$bot_group" "$BOT_DIR" 2>/dev/null || true
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
    chmod -R 755 "$BOT_DIR" 2>/dev/null || true
    chmod 600 "$BOT_DIR/.env" 2>/dev/null || true
    
    success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $bot_user"
}

# –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–¥–∞
update_code() {
    info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞..."
    
    cd "$BOT_DIR"
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
    git stash push -m "Auto-stash before update $(date)" || true
    
    # –ü–æ–ª—É—á–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    if ! git fetch origin 2>/dev/null; then
        error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π –∏–∑ git"
        warning "–í–æ–∑–º–æ–∂–Ω–æ, –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å git safe.directory:"
        warning "git config --global --add safe.directory $BOT_DIR"
        return 1
    fi
    
    if ! git reset --hard origin/master 2>/dev/null; then
        error "–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–æ–¥–∞"
        return 1
    fi
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞
    info "–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–∞–≤ –¥–æ—Å—Ç—É–ø–∞..."
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    local bot_user=$(stat -c '%U' "$BOT_DIR" 2>/dev/null)
    local bot_group=$(stat -c '%G' "$BOT_DIR" 2>/dev/null)
    
    # –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å, –ø—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ systemd —Å–µ—Ä–≤–∏—Å—É
    if [ -z "$bot_user" ] || [ -z "$bot_group" ]; then
        if systemctl is-active --quiet antispam-bot.service 2>/dev/null; then
            bot_user=$(systemctl show -p User --value antispam-bot.service 2>/dev/null || echo "")
            bot_group=$(systemctl show -p Group --value antispam-bot.service 2>/dev/null || echo "")
        fi
    fi
    
    # –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–æ, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if [ -z "$bot_user" ] || [ -z "$bot_group" ]; then
        bot_user=$(whoami)
        bot_group=$(id -gn)
    fi
    
    # –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –ø—Ä–∞–≤–∞ –Ω–∞ –≤—Å—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
    chown -R "$bot_user:$bot_group" "$BOT_DIR" 2>/dev/null || true
    
    # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø—Ä–∞–≤–∞ –Ω–∞ —Ñ–∞–π–ª—ã
    chmod -R 755 "$BOT_DIR" 2>/dev/null || true
    chmod 600 "$BOT_DIR/.env" 2>/dev/null || true
    
    success "–ü—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: $bot_user"
    
    success "–ö–æ–¥ –æ–±–Ω–æ–≤–ª–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
update_dependencies() {
    info "–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π..."
    
    if [ "$INSTALLATION_TYPE" = "systemd" ]; then
        # –û–±–Ω–æ–≤–ª—è–µ–º Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
        "$BOT_DIR/venv/bin/pip" install --upgrade pip
        "$BOT_DIR/venv/bin/pip" install -r "$BOT_DIR/requirements.txt"
        success "Python –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    elif [ "$INSTALLATION_TYPE" = "docker" ]; then
        # –û–±–Ω–æ–≤–ª—è–µ–º Docker –æ–±—Ä–∞–∑—ã
        cd "$BOT_DIR"
        docker-compose -f docker-compose.prod.yml pull
        success "Docker –æ–±—Ä–∞–∑—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã"
    fi
}

# –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—É—Å–∫–∞ —Å–µ—Ä–≤–∏—Å–∞
start_service() {
    info "–ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–∞..."
    
    if [ "$INSTALLATION_TYPE" = "docker" ]; then
        cd "$BOT_DIR"
        docker-compose -f docker-compose.prod.yml up -d --build
        systemctl start "${SERVICE_NAME}-docker"
    else
        systemctl start "$SERVICE_NAME"
    fi
    
    success "–°–µ—Ä–≤–∏—Å –∑–∞–ø—É—â–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞
check_status() {
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ —Å–µ—Ä–≤–∏—Å–∞..."
    
    sleep 5
    
    if [ "$INSTALLATION_TYPE" = "docker" ]; then
        if systemctl is-active --quiet "${SERVICE_NAME}-docker"; then
            success "Docker —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            error "Docker —Å–µ—Ä–≤–∏—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
            systemctl status "${SERVICE_NAME}-docker" --no-pager
            return 1
        fi
    else
        if systemctl is-active --quiet "$SERVICE_NAME"; then
            success "systemd —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç"
        else
            error "systemd —Å–µ—Ä–≤–∏—Å –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç"
            systemctl status "$SERVICE_NAME" --no-pager
            return 1
        fi
    fi
}

# –§—É–Ω–∫—Ü–∏—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–æ–≥–æ–≤
check_logs() {
    info "–ü—Ä–æ–≤–µ—Ä–∫–∞ –ª–æ–≥–æ–≤..."
    
    if [ "$INSTALLATION_TYPE" = "docker" ]; then
        echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ Docker:"
        docker-compose -f "$BOT_DIR/docker-compose.prod.yml" logs --tail=20
    else
        echo "–ü–æ—Å–ª–µ–¥–Ω–∏–µ –ª–æ–≥–∏ systemd:"
        journalctl -u "$SERVICE_NAME" --tail=20 --no-pager
    fi
}

# –§—É–Ω–∫—Ü–∏—è –æ—Ç–∫–∞—Ç–∞
rollback() {
    warning "–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ—Ç–∫–∞—Ç –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏..."
    
    # –ü–æ–∏—Å–∫ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –±—ç–∫–∞–ø–∞
    local latest_backup=$(ls -t "$BACKUP_DIR"/backup-* 2>/dev/null | head -n1)
    
    if [ -z "$latest_backup" ]; then
        error "–†–µ–∑–µ—Ä–≤–Ω–∞—è –∫–æ–ø–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        exit 1
    fi
    
    info "–û—Ç–∫–∞—Ç –∫ $latest_backup"
    
    # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
    stop_service
    
    # –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –±—ç–∫–∞–ø–∞
    rm -rf "$BOT_DIR"
    cp -r "$latest_backup" "$BOT_DIR"
    
    # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
    start_service
    
    success "–û—Ç–∫–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω"
}

# –§—É–Ω–∫—Ü–∏—è –æ—á–∏—Å—Ç–∫–∏ —Å—Ç–∞—Ä—ã—Ö –±—ç–∫–∞–ø–æ–≤
cleanup_backups() {
    info "–û—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π..."
    
    # –£–¥–∞–ª—è–µ–º –±—ç–∫–∞–ø—ã —Å—Ç–∞—Ä—à–µ 7 –¥–Ω–µ–π
    find "$BACKUP_DIR" -name "backup-*" -type d -mtime +7 -exec rm -rf {} \; 2>/dev/null || true
    
    success "–°—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏ —É–¥–∞–ª–µ–Ω—ã"
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
show_info() {
    echo ""
    success "üéâ –û–ë–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û!"
    echo ""
    echo -e "${GREEN}‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó${NC}"
    echo -e "${GREEN}‚ïë                    –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û–ë –û–ë–ù–û–í–õ–ï–ù–ò–ò                  ‚ïë${NC}"
    echo -e "${GREEN}‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù${NC}"
    echo ""
    echo -e "${YELLOW}üîß –¢–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏:${NC} $INSTALLATION_TYPE"
    echo -e "${YELLOW}üìÖ –î–∞—Ç–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:${NC} $(date)"
    echo -e "${YELLOW}üìÅ –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è:${NC} $BOT_DIR"
    echo -e "${YELLOW}üíæ –†–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏:${NC} $BACKUP_DIR"
    echo ""
    echo -e "${YELLOW}üìã –ö–æ–º–∞–Ω–¥—ã —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:${NC}"
    echo "  sudo systemctl status $SERVICE_NAME     - –°—Ç–∞—Ç—É—Å –±–æ—Ç–∞"
    echo "  sudo journalctl -u $SERVICE_NAME -f     - –ü—Ä–æ—Å–º–æ—Ç—Ä –ª–æ–≥–æ–≤"
    echo "  sudo systemctl restart $SERVICE_NAME    - –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –±–æ—Ç–∞"
    echo "  sudo systemctl stop $SERVICE_NAME       - –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –±–æ—Ç–∞"
    echo ""
    echo -e "${GREEN}‚úÖ –ë–æ—Ç –æ–±–Ω–æ–≤–ª–µ–Ω –∏ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!${NC}"
    echo ""
}

# –§—É–Ω–∫—Ü–∏—è –ø–æ–∫–∞–∑–∞ —Å–ø—Ä–∞–≤–∫–∏
show_help() {
    cat << EOF
–ò–°–ü–û–õ–¨–ó–û–í–ê–ù–ò–ï:
    $0 [–ö–û–ú–ê–ù–î–ê]

–ö–û–ú–ê–ù–î–´:
    update           - –û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    check            - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–æ—Å—Ç—É–ø–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    rollback         - –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
    logs             - –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
    status           - –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å —Å–µ—Ä–≤–∏—Å–∞
    fix-permissions  - –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ñ–∞–π–ª–∞–º
    cleanup          - –û—á–∏—Å—Ç–∏—Ç—å —Å—Ç–∞—Ä—ã–µ —Ä–µ–∑–µ—Ä–≤–Ω—ã–µ –∫–æ–ø–∏–∏
    help             - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É

–ü–†–ò–ú–ï–†–´:
    sudo $0                    # –û–±–Ω–æ–≤–∏—Ç—å –±–æ—Ç–∞
    sudo $0 check             # –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
    sudo $0 rollback          # –û—Ç–∫–∞—Ç–∏—Ç—å—Å—è –∫ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏
    sudo $0 logs              # –ü–æ–∫–∞–∑–∞—Ç—å –ª–æ–≥–∏
    sudo $0 status            # –ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—É—Å
    sudo $0 fix-permissions   # –ò—Å–ø—Ä–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞

–û–ü–ò–°–ê–ù–ò–ï:
    –°–∫—Ä–∏–ø—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏ (Docker/systemd)
    –∏ –≤—ã–ø–æ–ª–Ω—è–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–æ–∑–¥–∞–Ω–∏–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—ã—Ö –∫–æ–ø–∏–π.
EOF
}

# –ì–ª–∞–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
main() {
    show_header
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø—Ä–∞–≤–∞ root
    check_root
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
    detect_bot_directory
    
    # –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º git –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–µ–π (–∏—Å–ø—Ä–∞–≤–ª—è–µ–º –æ—à–∏–±–∫—É dubious ownership)
    if [ -n "$BOT_DIR" ] && [ -d "$BOT_DIR" ]; then
        git config --global --add safe.directory "$BOT_DIR" 2>/dev/null || true
    fi
    
    # –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø —É—Å—Ç–∞–Ω–æ–≤–∫–∏
    detect_installation_type
    
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –±–æ—Ç–∞
    check_bot_directory
    
    # –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –∫–æ–º–∞–Ω–¥—ã
    case "${1:-update}" in
        "update")
            info "–ù–∞—á–∏–Ω–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ..."
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            if ! check_updates; then
                info "–û–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–µ —Ç—Ä–µ–±—É—é—Ç—Å—è"
                exit 0
            fi
            
            # –°–æ–∑–¥–∞–µ–º —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
            create_backup
            
            # –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–µ—Ä–≤–∏—Å
            stop_service
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–¥
            update_code
            
            # –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
            update_dependencies
            
            # –ó–∞–ø—É—Å–∫–∞–µ–º —Å–µ—Ä–≤–∏—Å
            start_service
            
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ç—É—Å
            check_status
            
            # –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –±—ç–∫–∞–ø—ã
            cleanup_backups
            
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
            show_info
            ;;
        "check")
            check_updates
            ;;
        "rollback")
            rollback
            check_status
            ;;
        "logs")
            check_logs
            ;;
        "status")
            check_status
            ;;
        "cleanup")
            cleanup_backups
            ;;
        "fix-permissions")
            fix_permissions
            ;;
        "help")
            show_help
            ;;
        *)
            error "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–æ–º–∞–Ω–¥–∞: $1"
            show_help
            exit 1
            ;;
    esac
}

# –ó–∞–ø—É—Å–∫
main "$@"
