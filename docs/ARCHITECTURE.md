# üèóÔ∏è –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞ AntiSpam Bot

**üìÖ –û–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω–æ–≥–æ –∞—É–¥–∏—Ç–∞: 12 —Å–µ–Ω—Ç—è–±—Ä—è 2025**

---

## üèóÔ∏è **–î–ò–ê–ì–†–ê–ú–ú–ê –ê–†–•–ò–¢–ï–ö–¢–£–†–´**

```mermaid
flowchart TD
    subgraph Telegram
        U[–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–°–ø–∞–º–µ—Ä]
        TG[API Telegram]
    end

    U --> TG

    subgraph Bot[Flame_Of_Styx_bot]
        direction TB

        subgraph Middlewares
            M1[Dependency Injection]
            M2[Logging]
            M3[Rate Limit]
        end

        subgraph Handlers
            H1[User Handlers]
            H2[Admin Handlers]
        end

        subgraph Services
            S1[Moderation Service<br>(ban/kick/warn)]
            S2[Channel Service]
        end

        subgraph Models
            DB[(Database)]
            Mdl1[User/Ban Records]
            Mdl2[Channel Configs]
        end
    end

    TG --> M1 --> M2 --> M3 --> H1
    TG --> M1 --> M2 --> M3 --> H2

    H1 --> S1
    H1 --> S2
    H2 --> S1
    H2 --> S2

    S1 --> DB
    S2 --> DB
    DB --> Mdl1
    DB --> Mdl2
```

### üìå **–ö–∞–∫ —á–∏—Ç–∞—Ç—å –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—É:**
- **Middlewares**: –≤—Å–µ –∞–ø–¥–µ–π—Ç—ã –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ DI ‚Üí –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚Üí rate-limit
- **Handlers**: —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –ø–æ —Ç–∏–ø—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—é–∑–µ—Ä/–∞–¥–º–∏–Ω)
- **Services**: –∑–¥–µ—Å—å –æ—Å–Ω–æ–≤–Ω–∞—è –±–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞ –∞–Ω—Ç–∏—Å–ø–∞–º–∞
- **Models/DB**: —Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ –±–∞–Ω–æ–≤, whitelist/blacklist, –∫–æ–Ω—Ñ–∏–≥–æ–≤

---

## üîÑ **SEQUENCE –î–ò–ê–ì–†–ê–ú–ú–ê –û–ë–†–ê–ë–û–¢–ö–ò –°–û–û–ë–©–ï–ù–ò–ô**

```mermaid
sequenceDiagram
    participant U as –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å/–°–ø–∞–º–µ—Ä
    participant TG as Telegram API
    participant MW as Middlewares<br>(DI ‚Üí Logging ‚Üí RateLimit)
    participant H as Handler<br>(user/admin)
    participant S as Moderation Service
    participant DB as Database
    participant A as –ê–¥–º–∏–Ω (–ø–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—é)

    U->>TG: –û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    TG->>MW: Update (message/new_chat_member/...)
    MW->>H: –ü–µ—Ä–µ–¥–∞—á–∞ —Å–æ–±—ã—Ç–∏—è —Å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—è–º–∏

    H->>S: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
    S->>S: –§–∏–ª—å—Ç—Ä—ã (—Å—Å—ã–ª–∫–∏, —Ñ–ª—É–¥, –º–µ–¥–∏–∞, sender_chat, threads)
    S->>DB: –ó–∞–ø—Ä–æ—Å –∏—Å—Ç–æ—Ä–∏–∏ –Ω–∞—Ä—É—à–µ–Ω–∏–π
    DB-->>S: –î–∞–Ω–Ω—ã–µ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ/–Ω–∞—Ä—É—à–µ–Ω–∏—è—Ö

    alt –°–æ–æ–±—â–µ–Ω–∏–µ –æ–∫
        S-->>H: –†–∞–∑—Ä–µ—à–∏—Ç—å
        H-->>TG: –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Å—Ç–∞—ë—Ç—Å—è
    else –ù–∞—Ä—É—à–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ
        S-->>H: –†–µ—à–µ–Ω–∏–µ (warn/mute/ban/delete)
        H->>TG: –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ/–æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        H->>DB: –ó–∞–ø–∏—Å–∞—Ç—å —Ñ–∞–∫—Ç –Ω–∞—Ä—É—à–µ–Ω–∏—è
        H->>A: –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞ (–ª–æ–≥ –¥–µ–π—Å—Ç–≤–∏—è)
    end
```

---

## üìã **–¢–ê–ë–õ–ò–¶–ê –ü–†–ê–í–ò–õ –ê–ù–¢–ò–°–ü–ê–ú–ê**

| ‚Ññ  | –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è                    | –ü—Ä–∏–º–µ—Ä/Edge-case               | –î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞                                         | –ó–∞–ø–∏—Å—å –≤ –ë–î                   |
| -- | ---------------------------------- | ------------------------------ | ----------------------------------------------------- | ----------------------------- |
| 1  | **–°—Å—ã–ª–∫–∏ / –∏–Ω–≤–∞–π—Ç—ã**               | `t.me/...`, `http://...`       | –£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ, warn/ban –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –Ω–∞—Å—Ç—Ä–æ–µ–∫ | +1 –Ω–∞—Ä—É—à–µ–Ω–∏–µ –¥–ª—è user\_id     |
| 2  | **–§–ª—É–¥ (rate-limit)**              | 5+ —Å–æ–æ–±—â–µ–Ω–∏–π –∑–∞ < X —Å–µ–∫        | –£–¥–∞–ª–∏—Ç—å –ª–∏—à–Ω–∏–µ, –≤—Ä–µ–º–µ–Ω–Ω—ã–π mute                        | –°—á—ë—Ç—á–∏–∫ –Ω–∞—Ä—É—à–µ–Ω–∏–π –ø–æ user\_id |
| 3  | **–°–ø–∞–º-–º–µ–¥–∏–∞**                     | –ú–Ω–æ–≥–æ —Ñ–æ—Ç–æ/–≥–∏—Ñ/—Å—Ç–∏–∫–µ—Ä–æ–≤ –ø–æ–¥—Ä—è–¥ | –£–¥–∞–ª–∏—Ç—å, –≤–∞—Ä–Ω                                         | –ó–∞–ø–∏—Å–∞—Ç—å —Ç–∏–ø ¬´media\_spam¬ª    |
| 4  | **–ü–æ–≤—Ç–æ—Ä—è—é—â–∏–π—Å—è —Ç–µ–∫—Å—Ç**            | ¬´–ö—É–ø–∏ –∫—É—Ä—Å¬ª, —Å–∫–æ–ø–∏–ø–∞—â–µ–Ω–æ       | –£–¥–∞–ª–∏—Ç—å, warn                                         | –°–æ—Ö—Ä–∞–Ω–∏—Ç—å hash —Ç–µ–∫—Å—Ç–∞         |
| 5  | **Sender Chat (–∞–Ω–æ–Ω–∏–º–Ω—ã–µ –∫–∞–Ω–∞–ª—ã)** | –°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∏–º–µ–Ω–∏ –∫–∞–Ω–∞–ª–∞      | –£–¥–∞–ª–∏—Ç—å/–±–∞–Ω                                           | –§–ª–∞–≥ sender\_chat = true      |
| 6  | **–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç–∞–º (threads)** | –°–ø–∞–º –≤ —Ç—Ä–µ–¥–µ –ø–æ—Å—Ç–∞ –∫–∞–Ω–∞–ª–∞      | –£–¥–∞–ª–∏—Ç—å, —É–≤–µ–¥–æ–º–∏—Ç—å –∞–¥–º–∏–Ω–∞                             | thread\_id + user\_id         |
| 7  | **–§–æ—Ä–≤–∞—Ä–¥—ã**                       | –ü–µ—Ä–µ—Å–ª–∞–Ω–æ –∏–∑ —Å—Ç–æ—Ä–æ–Ω–Ω–µ–≥–æ —á–∞—Ç–∞   | –£–¥–∞–ª–∏—Ç—å, warn                                         | –û—Ç–º–µ—Ç–∫–∞ ¬´forwarded¬ª           |
| 8  | **–ù–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏**                | –ú–∞—Å—Å–æ–≤—ã–π –∑–∞—Ö–æ–¥ + –ø–æ—Å—Ç —Å–ø–∞–º–∞    | –ö–∏–∫/–±–∞–Ω —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏                    | –õ–æ–≥ join + spam\_msg          |
| 9  | **–ë–∞–Ω-—Å–ø–∏—Å–æ–∫ (blacklist)**         | user\_id –≤ —á—ë—Ä–Ω–æ–º —Å–ø–∏—Å–∫–µ       | –ê–≤—Ç–æ–±–∞–Ω –ø—Ä–∏ –ª—é–±–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏                           | –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ user\_id   |
| 10 | **Whitelist**                      | user\_id –≤ —Å–ø–∏—Å–∫–µ –¥–æ–≤–µ—Ä–µ–Ω–Ω—ã—Ö   | –°–æ–æ–±—â–µ–Ω–∏—è –≤—Å–µ–≥–¥–∞ –ø—Ä–æ–ø—É—Å–∫–∞—é—Ç—Å—è                         | –ò—Å–∫–ª—é—á–∞–µ—Ç—Å—è –∏–∑ –ø–æ–¥—Å—á—ë—Ç–∞       |

### üìå **–ö–∞–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–∞–±–ª–∏—Ü—É:**
- **–î–µ–π—Å—Ç–≤–∏–µ –±–æ—Ç–∞** –º–æ–∂–µ—Ç –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—Ç—å—Å—è (warn ‚Üí ban –ø–æ—Å–ª–µ N –Ω–∞—Ä—É—à–µ–Ω–∏–π)
- **–ó–∞–ø–∏—Å—å –≤ –ë–î** –Ω—É–∂–Ω–∞ –¥–ª—è —Ç–æ–≥–æ, —á—Ç–æ–±—ã —Ä–µ—à–µ–Ω–∏—è –±—ã–ª–∏ ¬´–ø–∞–º—è—Ç–ª–∏–≤—ã–º–∏¬ª
- **Whitelist/Blacklist** —Å—Ç–æ–∏—Ç –¥–µ—Ä–∂–∞—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π —Ç–∞–±–ª–∏—Ü–µ

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –º–æ–¥—É–ª–µ–π

### `app/handlers/` - –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
- **`user.py`** - –Ω–æ–≤—ã–µ —É—á–∞—Å—Ç–Ω–∏–∫–∏, —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **`channels.py`** - —Å–æ–æ–±—â–µ–Ω–∏—è –æ—Ç –∫–∞–Ω–∞–ª–æ–≤ (sender_chat)
- **`admin.py`** - –∞–¥–º–∏–Ω—Å–∫–∏–µ –∫–æ–º–∞–Ω–¥—ã

### `app/services/` - –ë–∏–∑–Ω–µ—Å-–ª–æ–≥–∏–∫–∞
- **`moderation.py`** - –±–∞–Ω/–º—É—Ç/—Ä–∞–∑–±–∞–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- **`links.py`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—Å—ã–ª–æ–∫ –Ω–∞ –±–æ—Ç–æ–≤
- **`channels.py`** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ whitelist/blacklist –∫–∞–Ω–∞–ª–æ–≤
- **`bots.py`** - —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ whitelist –±–æ—Ç–æ–≤
- **`profiles.py`** - –∞–Ω–∞–ª–∏–∑ –ø—Ä–æ—Ñ–∏–ª–µ–π GPT-–±–æ—Ç–æ–≤

### `app/middlewares/` - –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–µ –ü–û
- **`logging.py`** - –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö —Å–æ–±—ã—Ç–∏–π
- **`ratelimit.py`** - –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —á–∞—Å—Ç–æ—Ç—ã –∑–∞–ø—Ä–æ—Å–æ–≤
- **`dependency_injection.py`** - –≤–Ω–µ–¥—Ä–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π

### `app/filters/` - –§–∏–ª—å—Ç—Ä—ã
- **`is_admin.py`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
- **`is_admin_or_silent.py`** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–º–∏–Ω–∞ –∏–ª–∏ —Ç–∏—Ö–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ

### `app/keyboards/` - –ö–ª–∞–≤–∏–∞—Ç—É—Ä—ã
- **`inline.py`** - inline-–∫–Ω–æ–ø–∫–∏ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
- **`reply.py`** - –æ–±—ã—á–Ω—ã–µ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã

## üîÑ –ü–æ—Ç–æ–∫ –æ–±—Ä–∞–±–æ—Ç–∫–∏

1. **–ù–æ–≤—ã–π —É—á–∞—Å—Ç–Ω–∏–∫** ‚Üí `handlers/user.py` ‚Üí `services/moderation.py`
2. **–°–æ–æ–±—â–µ–Ω–∏–µ —Å —Å—Å—ã–ª–∫–æ–π** ‚Üí `handlers/user.py` ‚Üí `services/links.py`
3. **–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç –∫–∞–Ω–∞–ª–∞** ‚Üí `handlers/channels.py` ‚Üí `services/channels.py`
   - **–†–æ–¥–Ω–æ–π –∫–∞–Ω–∞–ª** ‚Üí –ø–æ–ª–Ω–∞—è —Å–≤–æ–±–æ–¥–∞
   - **–ß—É–∂–æ–π –∫–∞–Ω–∞–ª** ‚Üí –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Å–ø–∞–º + rate limiting
4. **–ê–¥–º–∏–Ω—Å–∫–∞—è –∫–æ–º–∞–Ω–¥–∞** ‚Üí `handlers/admin.py` ‚Üí —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å–µ—Ä–≤–∏—Å
5. **–ù–µ–∞–¥–º–∏–Ω** ‚Üí —Ç–∏—Ö–æ–µ –∏–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ (–±–µ–∑ –æ—Ç–≤–µ—Ç–∞)

## üóÑÔ∏è –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü—ã
- **`users`** - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö
- **`channels`** - whitelist/blacklist –∫–∞–Ω–∞–ª–æ–≤ (—Å—Ç–∞—Ç—É—Å—ã: ALLOWED, BLOCKED, PENDING, SUSPICIOUS)
- **`bots`** - whitelist –±–æ—Ç–æ–≤
- **`moderation_log`** - –ª–æ–≥–∏ –º–æ–¥–µ—Ä–∞—Ü–∏–∏
- **`suspicious_profiles`** - –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª–∏

## üîß –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

- **`.env`** - –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- **`app/config.py`** - –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ Pydantic
- **`app/database.py`** - –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î

## üöÄ –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

- **–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞**: Docker Compose
- **–ü—Ä–æ–¥–∞–∫—à–µ–Ω**: Systemd —Å–µ—Ä–≤–∏—Å –Ω–∞ Ubuntu 20.04
