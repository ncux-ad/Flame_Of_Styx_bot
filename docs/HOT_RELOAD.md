# 🔄 Hot-Reload для настроек бота

Система автоматического обновления конфигурации без перезапуска бота.

## ✨ Возможности

- **Автоматическое обновление** лимитов из файла `limits.json`
- **Мониторинг изменений** в реальном времени
- **Валидация** новых значений
- **Уведомления администраторов** об изменениях
- **Принудительная перезагрузка** через команды

## 🚀 Как использовать

### 1. Автоматическое обновление

Просто отредактируйте файл `limits.json`:

```json
{
  "max_messages_per_minute": 15,
  "max_links_per_message": 5,
  "ban_duration_hours": 48,
  "suspicion_threshold": 0.3
}
```

Изменения применятся автоматически в течение 2 секунд!

### 2. Команды администратора

#### `/reload_limits`
Принудительно перезагружает лимиты из файла:

```
/reload_limits
```

**Ответ:**
```
🔄 Лимиты перезагружены!

📊 Текущие лимиты:
• Сообщений в минуту: 15
• Ссылок в сообщении: 5
• Время блокировки: 48 часов
• Порог подозрительности: 0.3

✅ Изменения применены немедленно!
```

#### `/setlimit` (с hot-reload)
Изменяет лимит и применяет изменения немедленно:

```
/setlimit threshold 0.4
```

**Ответ:**
```
✅ Лимит обновлен!

📊 threshold изменен на 0.4

🔄 Изменения применены немедленно благодаря hot-reload!
```

### 3. Уведомления об изменениях

При изменении файла `limits.json` все администраторы получат уведомление:

```
🔄 Лимиты обновлены автоматически!

• max_messages_per_minute: 10 → 15
• max_links_per_message: 3 → 5
• ban_duration_hours: 24 → 48
• suspicion_threshold: 0.2 → 0.3

✅ Изменения вступили в силу немедленно
```

## 🔧 Технические детали

### Архитектура

```
┌─────────────────┐    ┌──────────────────┐    ┌─────────────────┐
│   limits.json   │───▶│  ConfigWatcher   │───▶│  LimitsService  │
│   (файл)        │    │  (мониторинг)    │    │  (кэширование)  │
└─────────────────┘    └──────────────────┘    └─────────────────┘
                                │
                                ▼
                       ┌──────────────────┐
                       │  LimitsHotReload │
                       │  (уведомления)   │
                       └──────────────────┘
```

### Компоненты

1. **ConfigWatcher** - мониторит изменения файлов
2. **LimitsHotReload** - обрабатывает изменения лимитов
3. **LimitsService** - кэширует и предоставляет лимиты

### Валидация

Система проверяет:
- **Типы данных** (int, float)
- **Диапазоны значений** (0 < threshold <= 1)
- **Обязательные поля** (все 4 лимита)
- **JSON формат** файла

### Обработка ошибок

- **Неверный JSON** - уведомление администраторов
- **Некорректные значения** - откат к предыдущим настройкам
- **Отсутствие файла** - использование значений по умолчанию

## 📋 Примеры использования

### Сценарий 1: Изменение порога подозрительности

1. Откройте `limits.json`
2. Измените `suspicion_threshold` с `0.2` на `0.4`
3. Сохраните файл
4. Через 2 секунды все администраторы получат уведомление
5. Новый порог применяется немедленно

### Сценарий 2: Массовое изменение лимитов

1. Отредактируйте несколько значений в `limits.json`
2. Сохраните файл
3. Система покажет все изменения в уведомлении
4. Все изменения применяются одновременно

### Сценарий 3: Принудительная перезагрузка

1. Используйте команду `/reload_limits`
2. Система перезагрузит лимиты из файла
3. Покажет текущие значения

## ⚠️ Важные замечания

### Безопасность
- Файл `limits.json` **НЕ** отслеживается Git
- Каждый администратор может иметь свои настройки
- Изменения применяются только локально

### Производительность
- Мониторинг происходит каждые 2 секунды
- Минимальная нагрузка на систему
- Кэширование предотвращает частые чтения файла

### Совместимость
- Работает с существующими командами `/setlimit`
- Не требует изменений в коде бота
- Обратная совместимость с ручным управлением

## 🐛 Отладка

### Логи
```
INFO - ConfigWatcher запущен для файла: limits.json
INFO - Обнаружены изменения в файле: limits.json
INFO - Лимиты успешно обновлены: {'max_messages_per_minute': 15, ...}
```

### Проверка статуса
Используйте команду `/setlimits` для просмотра текущих лимитов.

### Принудительная перезагрузка
Если что-то пошло не так, используйте `/reload_limits`.

## 🔮 Планы развития

- [ ] Hot-reload для других конфигурационных файлов
- [ ] Веб-интерфейс для управления настройками
- [ ] История изменений лимитов
- [ ] Откат к предыдущим настройкам
- [ ] Уведомления о некорректных значениях в реальном времени
