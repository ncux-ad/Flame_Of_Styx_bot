name: Git Secrets Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  git-secrets:
    name: Git Secrets Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for scan-history
      
    - name: Install Git Secrets
      run: |
        echo "ğŸ” Installing Git Secrets..."
        sudo apt-get update
        sudo apt-get install -y git-secrets
        
        # Verify installation
        git-secrets --version
        
    - name: Configure Git Secrets
      run: |
        echo "ğŸ”§ Configuring Git Secrets..."
        
        # Initialize git-secrets
        git secrets --install
        
        # Add patterns from .gitsecrets file
        if [ -f ".gitsecrets" ]; then
          echo "ğŸ“ Adding patterns from .gitsecrets..."
          while IFS= read -r line; do
            # Skip comments and empty lines
            if [[ ! "$line" =~ ^#.*$ ]] && [[ -n "$line" ]]; then
              git secrets --add "$line"
            fi
          done < .gitsecrets
        fi
        
        # Add common patterns
        echo "ğŸ” Adding common secret patterns..."
        git secrets --add 'password\s*=\s*[A-Za-z0-9!@#$%^&*()_+-=]{8,}'
        git secrets --add 'secret\s*=\s*[A-Za-z0-9!@#$%^&*()_+-=]{8,}'
        git secrets --add 'token\s*=\s*[A-Za-z0-9!@#$%^&*()_+-=]{8,}'
        git secrets --add 'key\s*=\s*[A-Za-z0-9!@#$%^&*()_+-=]{8,}'
        
        # Configure allowed patterns for test files
        echo "âœ… Configuring allowed patterns for test files..."
        git secrets --add --allowed 'test_token_[A-Za-z0-9_]+'
        git secrets --add --allowed 'test_[A-Za-z0-9_]+'
        git secrets --add --allowed 'dummy_[A-Za-z0-9_]+'
        git secrets --add --allowed 'example_[A-Za-z0-9_]+'
        git secrets --add --allowed 'your_[A-Za-z0-9_]+'
        
        # Configure allowed patterns for documentation
        echo "ğŸ“š Configuring allowed patterns for documentation..."
        git secrets --add --allowed 'BOT_TOKEN=test_token_'
        git secrets --add --allowed 'ADMIN_IDS=123456789'
        git secrets --add --allowed 'DB_PATH=test.db'
        
    - name: Scan current files
      run: |
        echo "ğŸ” Scanning current files for secrets..."
        if git secrets --scan; then
          echo "âœ… No secrets found in current files"
        else
          echo "âŒ Secrets found in current files!"
          echo "Please remove any secrets before committing."
          exit 1
        fi
        
    - name: Scan commit history
      run: |
        echo "ğŸ” Scanning commit history for secrets..."
        if git secrets --scan-history; then
          echo "âœ… No secrets found in commit history"
        else
          echo "âŒ Secrets found in commit history!"
          echo "Please review and remove any secrets from the history."
          exit 1
        fi
        
    - name: Generate secrets report
      if: always()
      run: |
        echo "ğŸ“Š Generating secrets scan report..."
        echo "## Git Secrets Scan Report" > secrets-report.md
        echo "" >> secrets-report.md
        echo "**Scan Date:** $(date)" >> secrets-report.md
        echo "**Repository:** ${{ github.repository }}" >> secrets-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> secrets-report.md
        echo "**Commit:** ${{ github.sha }}" >> secrets-report.md
        echo "" >> secrets-report.md
        
        # Check if secrets were found
        if git secrets --scan 2>&1 | grep -q "secrets were detected"; then
          echo "**Status:** âŒ Secrets detected" >> secrets-report.md
          echo "" >> secrets-report.md
          echo "### Detected Secrets:" >> secrets-report.md
          echo '```' >> secrets-report.md
          git secrets --scan 2>&1 >> secrets-report.md
          echo '```' >> secrets-report.md
        else
          echo "**Status:** âœ… No secrets detected" >> secrets-report.md
        fi
        
        echo "ğŸ“„ Report generated: secrets-report.md"
        
    - name: Upload secrets report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: git-secrets-report
        path: secrets-report.md
        retention-days: 30
