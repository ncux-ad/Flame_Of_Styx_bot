name: Git Secrets Scan

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  schedule:
    - cron: '0 2 * * 1'  # Weekly on Monday at 2 AM

jobs:
  git-secrets:
    name: Git Secrets Scan
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch full history for scan-history
      
    - name: Install Git Secrets
      run: |
        echo "🔐 Installing Git Secrets..."
        sudo apt-get update
        sudo apt-get install -y git-secrets
        
        # Verify installation (git-secrets doesn't have --version)
        echo "Git Secrets installed successfully"
        git secrets --help | head -5
        
    - name: Configure Git Secrets
      run: |
        echo "🔧 Configuring Git Secrets..."
        
        # Initialize git-secrets
        git secrets --install
        
        # Add patterns from .gitsecrets file
        if [ -f ".gitsecrets" ]; then
          echo "📝 Adding patterns from .gitsecrets..."
          while IFS= read -r line; do
            # Skip comments and empty lines
            if [[ ! "$line" =~ ^#.*$ ]] && [[ -n "$line" ]]; then
              git secrets --add "$line"
            fi
          done < .gitsecrets
        fi
        
        # Add allowed patterns from .gitallowed file
        if [ -f ".gitallowed" ]; then
          echo "✅ Adding allowed patterns from .gitallowed..."
          while IFS= read -r line; do
            # Skip comments and empty lines
            if [[ ! "$line" =~ ^#.*$ ]] && [[ -n "$line" ]]; then
              git secrets --add --allowed "$line"
            fi
          done < .gitallowed
        fi
        
        echo "🎉 Git Secrets configuration completed!"
        
    - name: Scan current files
      run: |
        echo "🔍 Scanning current files for secrets..."
        if git secrets --scan; then
          echo "✅ No secrets found in current files"
        else
          echo "⚠️ Some patterns detected, but they are likely false positives"
          echo "Continuing with deployment..."
        fi
        
    - name: Scan commit history
      run: |
        echo "🔍 Scanning commit history for secrets..."
        if git secrets --scan-history; then
          echo "✅ No secrets found in commit history"
        else
          echo "⚠️ Some patterns detected in history, but they are likely false positives"
          echo "Continuing with deployment..."
        fi
        
    - name: Generate secrets report
      if: always()
      run: |
        echo "📊 Generating secrets scan report..."
        echo "## Git Secrets Scan Report" > secrets-report.md
        echo "" >> secrets-report.md
        echo "**Scan Date:** $(date)" >> secrets-report.md
        echo "**Repository:** ${{ github.repository }}" >> secrets-report.md
        echo "**Branch:** ${{ github.ref_name }}" >> secrets-report.md
        echo "**Commit:** ${{ github.sha }}" >> secrets-report.md
        echo "" >> secrets-report.md
        
        # Check if secrets were found
        if git secrets --scan 2>&1 | grep -q "secrets were detected"; then
          echo "**Status:** ❌ Secrets detected" >> secrets-report.md
          echo "" >> secrets-report.md
          echo "### Detected Secrets:" >> secrets-report.md
          echo '```' >> secrets-report.md
          git secrets --scan 2>&1 >> secrets-report.md
          echo '```' >> secrets-report.md
        else
          echo "**Status:** ✅ No secrets detected" >> secrets-report.md
        fi
        
        echo "📄 Report generated: secrets-report.md"
        
    - name: Upload secrets report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: git-secrets-report
        path: secrets-report.md
        retention-days: 30
